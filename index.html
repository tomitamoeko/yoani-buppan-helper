<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <title>イコノイジョイ 物販情報</title>
</head>

<body>
    <ul id="list"></ul>

    <script>
        function official_site_to_group(site_url) {
            switch (site_url) {
                case "https://equal-love.jp/":
                    return "equal-love";
                case "https://not-equal-me.jp/":
                    return "not-equal-me";
                case "https://nearly-equal-joy.jp/":
                    return "nearly-equal-joy";
                default:
                    return "unknown";
            }
        }

        function generate_shop_link(event) {
            return `https://monosys.net/${event.group}/${event.id}`
        }

        async function get_event_list() {
            try {
                const response = await fetch("https://firestore.googleapis.com/v1/projects/yoani-buppan-dev/databases/(default)/documents/events-prod");
                if (!response.ok) {
                    throw new Error("Network error:" + response.statusText);
                }
                const events = (await response.json()).documents ?? [];
                console.log(`Got ${events.length} entries`);

                return events.map(event => {
                    const created_time = new Date(event.createTime);

                    return {
                        id: event.name.split('/').pop(),
                        name: event.fields.event_name.stringValue,
                        group: official_site_to_group(event.fields.official_site_url?.stringValue ?? ""),
                        created: created_time.getTime()
                    }
                });
            } catch (error) {
                console.error("Fetch error: ", error);
                return [];
            }
        }

        (async () => {
            const event_list = await get_event_list();
            event_list.sort((a, b) => b.created - a.created);
            console.log(event_list);

            const html_list = event_list.map(event =>
                `<li><a href="${generate_shop_link(event)}" rel="noopener noreferrer">${event.name}</a></li>`
            ).join('');

            document.getElementById("list").innerHTML = html_list;
        })();
    </script>
</body>

</html>
